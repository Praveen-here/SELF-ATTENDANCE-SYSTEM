<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Attendance</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
    /* Custom CSS */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Poppins', sans-serif;
    }

    body {
        background: linear-gradient(to right, #141e30, #243b55);
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
    }

    .attendance-container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 10px;
        padding: 2rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        width: 100%;
        max-width: 500px;
    }

    h1 {
        text-align: center;
        margin-bottom: 1.5rem;
        font-size: 1.8rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .session-info {
        background: rgba(0, 217, 255, 0.1);
        border: 1px solid rgba(0, 217, 255, 0.3);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        text-align: center;
        font-size: 0.9rem;
    }

    .timer {
        font-weight: bold;
        color: #00d9ff;
        font-size: 1.1rem;
    }

    #search {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.2);
        color: white;
        transition: all 0.3s ease;
    }

    #search:focus {
        border-color: #00d9ff;
        box-shadow: 0 0 10px rgba(0, 217, 255, 0.6);
    }

    .student-list {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        overflow-y: auto;
        max-height: 16rem;
    }

    .student-row {
        transition: all 0.3s ease;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .student-row:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .selected-row {
        background: rgba(0, 217, 255, 0.2);
    }

    button {
        background: linear-gradient(to right, #00d9ff, #0099ff);
        transition: all 0.3s ease;
        letter-spacing: 0.5px;
    }

    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 217, 255, 0.4);
    }

    button:disabled {
        background: rgba(255, 255, 255, 0.2);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    #alert {
        border-radius: 6px;
        transition: all 0.3s ease;
    }

    .expired {
        background: rgba(255, 0, 0, 0.2);
        border-color: rgba(255, 0, 0, 0.5);
    }

    @media (max-width: 768px) {
        .attendance-container {
            padding: 1.5rem;
        }
        h1 {
            font-size: 1.5rem;
        }
    }
</style>
</head>
<body>
<div class="attendance-container">
    <h1>Mark Attendance</h1>

    <div class="session-info">
        <div>Session Status: <span id="session-status" class="timer">Validating...</span></div>
        <div>Time Remaining: <span id="timer" class="timer">--:--</span></div>
        <div style="font-size: 0.8rem; margin-top: 0.5rem; color: rgba(255,255,255,0.7);">
            Device ID: <span id="device-id">Generating...</span>
        </div>
    </div>

    <div id="alert" class="hidden mb-4 p-3 rounded"></div>

    <div class="mb-4">
        <input type="text" id="search" placeholder="Search by name or ID"
               class="w-full p-3 rounded-lg mb-4">
    </div>

    <div class="student-list">
        <table class="w-full">
            <tbody id="students"></tbody>
        </table>
    </div>

    <button id="submit-btn" onclick="submitAttendance()"
            class="mt-6 w-full py-3 rounded-lg text-white font-semibold"
            disabled>
        Mark Attendance
    </button>
</div>

<script>
    let selectedStudent = null;
    let sessionToken = null;
    let sessionExpired = false;
    let countdownTimer = null;
    let deviceFingerprint = null;

    const urlParams = new URLSearchParams(window.location.search);
    const subject = urlParams.get('subject');
    const date = urlParams.get('date');
    sessionToken = urlParams.get('session');

    // Enhanced device fingerprint generation
    async function generateDeviceFingerprint() {
        const components = [];
        
        // Basic browser info
        components.push(navigator.userAgent || 'unknown');
        components.push(navigator.language || 'unknown');
        components.push(navigator.platform || 'unknown');
        components.push(navigator.cookieEnabled ? 'cookies-enabled' : 'cookies-disabled');
        
        // Screen properties
        components.push(`${screen.width}x${screen.height}`);
        components.push(`${screen.availWidth}x${screen.availHeight}`);
        components.push(screen.colorDepth || 'unknown');
        components.push(screen.pixelDepth || 'unknown');
        
        // Timezone
        components.push(new Date().getTimezoneOffset().toString());
        components.push(Intl.DateTimeFormat().resolvedOptions().timeZone || 'unknown');
        
        // Hardware info
        components.push(navigator.hardwareConcurrency || 'unknown');
        components.push(navigator.deviceMemory || 'unknown');
        components.push(navigator.maxTouchPoints || 'unknown');
        
        // WebGL fingerprint
        try {
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            if (gl) {
                const renderer = gl.getParameter(gl.RENDERER);
                const vendor = gl.getParameter(gl.VENDOR);
                components.push(renderer || 'webgl-unknown');
                components.push(vendor || 'vendor-unknown');
            }
        } catch (e) {
            components.push('webgl-error');
        }
        
        // Canvas fingerprint
        try {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillStyle = '#f60';
            ctx.fillRect(125, 1, 62, 20);
            ctx.fillStyle = '#069';
            ctx.fillText('Device fingerprint ðŸ”’', 2, 15);
            ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
            ctx.fillText('Canvas test', 4, 45);
            components.push(canvas.toDataURL());
        } catch (e) {
            components.push('canvas-error');
        }
        
        // Audio context fingerprint
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const analyser = audioContext.createAnalyser();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(analyser);
            analyser.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 10000;
            gainNode.gain.value = 0;
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            
            components.push(Array.from(dataArray).slice(0, 10).join(','));
            audioContext.close();
        } catch (e) {
            components.push('audio-error');
        }
        
        // Media devices (if available)
        try {
            if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const deviceTypes = devices.map(d => d.kind).sort().join(',');
                components.push(deviceTypes || 'no-media-devices');
            }
        } catch (e) {
            components.push('media-devices-error');
        }
        
        // Performance and memory info
        if (performance && performance.memory) {
            components.push(performance.memory.usedJSHeapSize?.toString() || 'heap-unknown');
        }
        
        // Battery API (if available)
        try {
            if ('getBattery' in navigator) {
                const battery = await navigator.getBattery();
                components.push(`battery-${battery.level}-${battery.charging}`);
            }
        } catch (e) {
            components.push('battery-error');
        }
        
        // Network info
        if (navigator.connection) {
            components.push(navigator.connection.effectiveType || 'connection-unknown');
            components.push(navigator.connection.downlink?.toString() || 'downlink-unknown');
        }
        
        // Add current timestamp and random component for extra uniqueness
        components.push(Date.now().toString());
        components.push(Math.random().toString(36).substring(2, 15));
        
        // Create hash of all components
        const fingerprint = await crypto.subtle.digest('SHA-256', 
            new TextEncoder().encode(components.join('|'))
        );
        
        const hashArray = Array.from(new Uint8Array(fingerprint));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        
        console.log('Device fingerprint components:', components.length);
        console.log('Generated fingerprint:', hashHex.substring(0, 16) + '...');
        
        return hashHex;
    }

    // Validate session and setup timer
    function validateSession() {
        if (!sessionToken || !date || !subject) {
            document.body.innerHTML = `
                <div class="attendance-container text-center text-red-500">
                    <h1>Invalid Attendance Link</h1>
                    <p>Please scan a valid QR code from your teacher.</p>
                </div>
            `;
            return false;
        }

        try {
            const [timestamp] = sessionToken.split('_');
            const sessionTime = parseInt(timestamp);
            const currentTime = Date.now();
            const sessionAge = currentTime - sessionTime;
            const maxAge = 10 * 60 * 1000; // 10 minutes

            if (sessionAge >= maxAge) {
                showExpiredSession();
                return false;
            }

            // Setup countdown timer
            startCountdown(maxAge - sessionAge);
            document.getElementById('session-status').textContent = 'Active';
            document.getElementById('session-status').style.color = '#00ff00';
            
            return true;
        } catch (error) {
            showExpiredSession();
            return false;
        }
    }

    function startCountdown(timeLeft) {
        countdownTimer = setInterval(() => {
            if (timeLeft <= 0) {
                showExpiredSession();
                return;
            }

            const minutes = Math.floor(timeLeft / 60000);
            const seconds = Math.floor((timeLeft % 60000) / 1000);
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            timeLeft -= 1000;
        }, 1000);
    }

    function showExpiredSession() {
        sessionExpired = true;
        clearInterval(countdownTimer);
        document.getElementById('session-status').textContent = 'Expired';
        document.getElementById('session-status').style.color = '#ff0000';
        document.getElementById('timer').textContent = '00:00';
        document.querySelector('.session-info').classList.add('expired');
        document.getElementById('submit-btn').disabled = true;
        document.getElementById('submit-btn').textContent = 'Session Expired';
        showAlert('QR code session has expired. Please scan a fresh QR code.', 'red');
    }

    // Initialize page
    if (validateSession()) {
        generateDeviceFingerprint().then(fingerprint => {
            deviceFingerprint = fingerprint;
            document.getElementById('device-id').textContent = fingerprint.substring(0, 16) + '...';
            document.title = `${subject} Attendance - ${date}`;
            loadStudents();
        }).catch(error => {
            console.error('Error generating device fingerprint:', error);
            // Fallback to simpler fingerprint
            deviceFingerprint = btoa(navigator.userAgent + Date.now()).substring(0, 32);
            document.getElementById('device-id').textContent = deviceFingerprint.substring(0, 16) + '...';
            document.title = `${subject} Attendance - ${date}`;
            loadStudents();
        });
    }

    async function loadStudents() {
        try {
            const res = await fetch('/student/attendance-students');
            if (!res.ok) throw new Error('Failed to fetch students');

            const students = await res.json();
            const tbody = document.getElementById('students');

            tbody.innerHTML = students.map(student => `
                <tr class="cursor-pointer student-row"
                    data-id="${student.studentID}"
                    onclick="selectStudent('${student.studentID}', '${student.name}', event)">
                    <td class="p-3">${student.studentID}</td>
                    <td class="p-3">${student.name}</td>
                </tr>
            `).join('');

            document.getElementById('search').addEventListener('input', (e) => {
                const search = e.target.value.toLowerCase();
                document.querySelectorAll('.student-row').forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(search) ? '' : 'none';
                });
            });

            // Enable submit button after students load
            document.getElementById('submit-btn').disabled = false;

        } catch (error) {
            showAlert('Error loading students', 'red');
            console.error('Student load error:', error);
        }
    }

    function selectStudent(id, name, event) {
        if (sessionExpired) {
            showAlert('Session expired. Cannot select student.', 'red');
            return;
        }
        
        selectedStudent = id;
        document.querySelectorAll('.student-row').forEach(row => {
            row.classList.remove('selected-row');
        });
        event.currentTarget.classList.add('selected-row');
    }

    async function submitAttendance() {
        if (sessionExpired) {
            showAlert('Session has expired. Please scan a fresh QR code.', 'red');
            return;
        }

        if (!selectedStudent) {
            return showAlert('Please select a student', 'red');
        }

        // Disable button to prevent multiple submissions
        document.getElementById('submit-btn').disabled = true;
        document.getElementById('submit-btn').textContent = 'Submitting...';

        try {
            const res = await fetch('/student/submit-attendance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    studentID: selectedStudent,
                    date,
                    subject,
                    sessionToken
                })
            });

            const data = await res.json();
            
            if (!res.ok) {
                throw new Error(data.message);
            }

            showAlert(`Attendance marked successfully for ${subject}!`, 'green');
            
            // Clear selection and disable further submissions
            selectedStudent = null;
            document.querySelectorAll('.student-row').forEach(row => {
                row.classList.remove('selected-row');
                row.style.pointerEvents = 'none';
                row.style.opacity = '0.5';
            });
            
            document.getElementById('submit-btn').textContent = 'Attendance Submitted';
            
            setTimeout(() => {
                showAlert('You may now close this page. Thank you!', 'blue');
            }, 2000);

        } catch (error) {
            // Re-enable button if submission failed
            document.getElementById('submit-btn').disabled = false;
            document.getElementById('submit-btn').textContent = 'Mark Attendance';
            
            let message = error.message;
            if (message.includes('already submitted') || message.includes('duplicate')) {
                message = `Attendance already submitted for ${subject} today.`;
            } else if (message.includes('expired')) {
                showExpiredSession();
                return;
            }
            
            showAlert(message, 'red');
            console.error('Attendance submission error:', error);
        }
    }

    function showAlert(message, color = 'blue') {
        const alertDiv = document.getElementById('alert');
        alertDiv.textContent = message;
        alertDiv.className = `bg-${color}-500/20 text-${color}-300 p-3 rounded`;
        alertDiv.classList.remove('hidden');
        
        // Auto-hide success messages
        if (color === 'green') {
            setTimeout(() => alertDiv.classList.add('hidden'), 5000);
        }
    }

    // Prevent page refresh/back button after successful submission
    window.addEventListener('beforeunload', (e) => {
        if (selectedStudent === null && !sessionExpired) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    // Handle page visibility change (detect tab switching)
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            console.log('Tab hidden - user might be attempting workarounds');
        }
    });
</script>
</body>
</html>
